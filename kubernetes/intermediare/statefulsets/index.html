<!doctype html><html lang=en class="js csstransforms3d"><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.128.0"><meta name=description content="Tutoriel sur Kubernetes"><meta name=author content="Maxime Calves"><link rel=icon href=/kubernetes-tutorial/images/favicon.png type=image/png><title>StatefulSets :: Kubernetes Tutoriel</title>
<link href=/kubernetes-tutorial/css/nucleus.css?1719415791 rel=stylesheet><link href=/kubernetes-tutorial/css/fontawesome-all.min.css?1719415791 rel=stylesheet><link href=/kubernetes-tutorial/css/hybrid.css?1719415791 rel=stylesheet><link href=/kubernetes-tutorial/css/featherlight.min.css?1719415791 rel=stylesheet><link href=/kubernetes-tutorial/css/perfect-scrollbar.min.css?1719415791 rel=stylesheet><link href=/kubernetes-tutorial/css/auto-complete.css?1719415791 rel=stylesheet><link href=/kubernetes-tutorial/css/atom-one-dark-reasonable.css?1719415791 rel=stylesheet><link href=/kubernetes-tutorial/css/theme.css?1719415791 rel=stylesheet><link href=/kubernetes-tutorial/css/tabs.css?1719415791 rel=stylesheet><link href=/kubernetes-tutorial/css/hugo-theme.css?1719415791 rel=stylesheet><link href=/kubernetes-tutorial/css/theme-blue.css?1719415791 rel=stylesheet><script src=/kubernetes-tutorial/js/jquery-3.3.1.min.js?1719415791></script><style>:root #header+#content>#left>#rlblock_left{display:none!important}</style></head><body data-url=/kubernetes-tutorial/kubernetes/intermediare/statefulsets/><nav id=sidebar class=showVisitedLinks><div id=header-wrapper><div id=header><img src=../../../../kubernetes-tutorial/media/logo.png></div><div class=searchbox><label for=search-by><i class="fas fa-search"></i></label>
<input data-search-input id=search-by type=search placeholder=Search...>
<span data-search-clear><i class="fas fa-times"></i></span></div><script type=text/javascript src=/kubernetes-tutorial/js/lunr.min.js?1719415791></script><script type=text/javascript src=/kubernetes-tutorial/js/auto-complete.js?1719415791></script><script type=text/javascript>var baseurl="https://maxime-cls.github.io/kubernetes-tutorial/"</script><script type=text/javascript src=/kubernetes-tutorial/js/search.js?1719415791></script></div><div class=highlightable><ul class=topics><li data-nav-id=/kubernetes-tutorial/kubernetes/ title=Kubernetes class="dd-item
parent"><a href=/kubernetes-tutorial/kubernetes/>Kubernetes
<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/kubernetes-tutorial/kubernetes/d%C3%A9butant/ title=Débutant class=dd-item><a href=/kubernetes-tutorial/kubernetes/d%C3%A9butant/>Débutant
<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/kubernetes-tutorial/kubernetes/d%C3%A9butant/kubectl/ title=Kubectl class=dd-item><a href=/kubernetes-tutorial/kubernetes/d%C3%A9butant/kubectl/>Kubectl
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/kubernetes-tutorial/kubernetes/d%C3%A9butant/pod-replica-deployment/ title="Pod, Replicaset, Deployment" class=dd-item><a href=/kubernetes-tutorial/kubernetes/d%C3%A9butant/pod-replica-deployment/>Pod, Replicaset, Deployment
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/kubernetes-tutorial/kubernetes/d%C3%A9butant/services/ title=Service class=dd-item><a href=/kubernetes-tutorial/kubernetes/d%C3%A9butant/services/>Service
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/kubernetes-tutorial/kubernetes/d%C3%A9butant/logs/ title=Logs class=dd-item><a href=/kubernetes-tutorial/kubernetes/d%C3%A9butant/logs/>Logs
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/kubernetes-tutorial/kubernetes/d%C3%A9butant/servicemagic/ title="Service Magic" class=dd-item><a href=/kubernetes-tutorial/kubernetes/d%C3%A9butant/servicemagic/>Service Magic
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/kubernetes-tutorial/kubernetes/d%C3%A9butant/blue-green/ title="Déploiement Blue/Green" class=dd-item><a href=/kubernetes-tutorial/kubernetes/d%C3%A9butant/blue-green/>Déploiement Blue/Green
<i class="fas fa-check read-icon"></i></a></li></ul></li><li data-nav-id=/kubernetes-tutorial/kubernetes/%C3%A9l%C3%A9mentaire/ title=Elementaire class=dd-item><a href=/kubernetes-tutorial/kubernetes/%C3%A9l%C3%A9mentaire/>Elementaire
<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/kubernetes-tutorial/kubernetes/%C3%A9l%C3%A9mentaire/ressources-limites/ title="Ressources et limites" class=dd-item><a href=/kubernetes-tutorial/kubernetes/%C3%A9l%C3%A9mentaire/ressources-limites/>Ressources et limites
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/kubernetes-tutorial/kubernetes/%C3%A9l%C3%A9mentaire/mise-a-jour/ title="Mise à jour permanentes" class=dd-item><a href=/kubernetes-tutorial/kubernetes/%C3%A9l%C3%A9mentaire/mise-a-jour/>Mise à jour permanentes
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/kubernetes-tutorial/kubernetes/%C3%A9l%C3%A9mentaire/liveness-readiness/ title="Liveness & Readiness" class=dd-item><a href=/kubernetes-tutorial/kubernetes/%C3%A9l%C3%A9mentaire/liveness-readiness/>Liveness & Readiness
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/kubernetes-tutorial/kubernetes/%C3%A9l%C3%A9mentaire/configmap/ title=Configmap class=dd-item><a href=/kubernetes-tutorial/kubernetes/%C3%A9l%C3%A9mentaire/configmap/>Configmap
<i class="fas fa-check read-icon"></i></a></li></ul></li><li data-nav-id=/kubernetes-tutorial/kubernetes/intermediare/ title=Intermediare class="dd-item
parent"><a href=/kubernetes-tutorial/kubernetes/intermediare/>Intermediare
<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/kubernetes-tutorial/kubernetes/intermediare/secret/ title=Secret class=dd-item><a href=/kubernetes-tutorial/kubernetes/intermediare/secret/>Secret
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/kubernetes-tutorial/kubernetes/intermediare/operator/ title=Operator class=dd-item><a href=/kubernetes-tutorial/kubernetes/intermediare/operator/>Operator
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/kubernetes-tutorial/kubernetes/intermediare/volumes/ title=Volumes class=dd-item><a href=/kubernetes-tutorial/kubernetes/intermediare/volumes/>Volumes
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/kubernetes-tutorial/kubernetes/intermediare/taints_affinity/ title="Taints et Affinity" class=dd-item><a href=/kubernetes-tutorial/kubernetes/intermediare/taints_affinity/>Taints et Affinity
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/kubernetes-tutorial/kubernetes/intermediare/job_cronjob/ title="Job & CronJob" class=dd-item><a href=/kubernetes-tutorial/kubernetes/intermediare/job_cronjob/>Job & CronJob
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/kubernetes-tutorial/kubernetes/intermediare/daemonset/ title=Daemonset class=dd-item><a href=/kubernetes-tutorial/kubernetes/intermediare/daemonset/>Daemonset
<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/kubernetes-tutorial/kubernetes/intermediare/statefulsets/ title=StatefulSets class="dd-item active"><a href=/kubernetes-tutorial/kubernetes/intermediare/statefulsets/>StatefulSets
<i class="fas fa-check read-icon"></i></a></li></ul></li><li data-nav-id=/kubernetes-tutorial/kubernetes/avance/ title=Avancé class=dd-item><a href=/kubernetes-tutorial/kubernetes/avance/>Avancé
<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/kubernetes-tutorial/kubernetes/avance/ingress/ title=Ingress class=dd-item><a href=/kubernetes-tutorial/kubernetes/avance/ingress/>Ingress
<i class="fas fa-check read-icon"></i></a></li></ul></li></ul></li></ul><section id=prefooter><hr><ul><li><a class=padding href=# data-clear-history-toggle><i class="fas fa-history fa-fw"></i> Clear History</a></li></ul></section><section id=footer><p>Built with <a href=https://github.com/matcornic/hugo-theme-learn><i class="fas fa-heart"></i></a> from <a href=https://getgrav.org>Grav</a> and <a href=https://gohugo.io/>Hugo</a></p></section></div></nav><section id=body><div id=overlay></div><div class="padding highlightable"><div><div id=top-bar><div id=breadcrumbs itemscope itemtype=http://data-vocabulary.org/Breadcrumb><span id=sidebar-toggle-span><a href=# id=sidebar-toggle data-sidebar-toggle><i class="fas fa-bars"></i>
</a></span><span id=toc-menu><i class="fas fa-list-alt"></i></span>
<span class=links><a href=/kubernetes-tutorial/>Kubernetes Tutoriel</a> > <a href=/kubernetes-tutorial/kubernetes/>Kubernetes</a> > <a href=/kubernetes-tutorial/kubernetes/intermediare/>Intermediare</a> > StatefulSets</span></div><div class=progress><div class=wrapper><nav id=TableOfContents><ul><li><a href=#prérequis>Prérequis</a></li><li><a href=#preparation>Preparation</a></li><li><a href=#statefulset>StatefulSet</a></li></ul></nav></div></div></div></div><div id=head-tags></div><div id=body-inner><h1>StatefulSets</h1><h2 id=prérequis>Prérequis</h2><ul><li>Minikube <a href=https://kubernetes.io/fr/docs/tasks/tools/install-minikube/#installez-minikube-par-t%C3%A9l%C3%A9chargement-direct>Install</a> <a href=https://kubernetes.io/docs/setup/learning-environment/minikube/#specifying-the-vm-driver>Driver none</a></li><li>kubectl <a href=https://kubernetes.io/fr/docs/tasks/tools/install-kubectl/>Install</a></li><li>Stern <a href=https://kubernetes.io/blog/2016/10/tail-kubernetes-with-stern/>Docs</a> <a href=https://github.com/stern/stern/releases>Release</a></li><li>jq <a href=https://stedolan.github.io/jq/download/>Install</a></li><li>3 terminal SSH</li></ul><h2 id=preparation>Preparation</h2><p>Si vous exécutez ce tutoriel dans Minikube, vous devez déployer un seul noeud :</p><pre tabindex=0><code>minikube stop
minikube delete --all
minikube start --vm-driver=none
</code></pre><h2 id=statefulset>StatefulSet</h2><p>Un StatefulSet fournit une identité unique aux Pods qui le gèrent. Il peut être utilisé lorsque votre application nécessite un identifiant réseau unique ou un stockage de persistance à travers la (re)programmation des pods ou une certaine garantie sur l&rsquo;ordre de déploiement et de mise à l&rsquo;échelle.</p><p>L&rsquo;un des exemples les plus typiques de l&rsquo;utilisation des StatefulSets est le déploiement de serveurs primaires et secondaires (par exemple, un cluster de base de données) pour lequel vous devez connaître à l&rsquo;avance le nom d&rsquo;hôte de chacun des serveurs pour démarrer le cluster. De même, lorsque vous effectuez une montée en charge ou une descente en charge, vous souhaitez le faire dans un ordre précis (par exemple, vous souhaitez démarrer d&rsquo;abord le nœud primaire, puis le nœud secondaire).</p><p>StatefulSet est créé en utilisant la ressource Kubernetes StatefulSet avec un service sans headless :</p><pre tabindex=0><code>vim  apps/kubefiles/quarkus-statefulset.yaml
</code></pre><pre tabindex=0><code>apiVersion: apps/v1beta1
kind: StatefulSet
metadata:
  name: quarkus-statefulset
  labels:
    app: quarkus-statefulset
spec:
  serviceName: &#34;quarkus&#34; (1)
  replicas: 2
  template:
    metadata:
      labels:
        app: quarkus-statefulset
    spec:
      containers:
      - name: quarkus-statefulset
        image: quay.io/rhdevelopers/quarkus-demo:v1
        ports:
        - containerPort: 8080
          name: web
</code></pre><p>1- Définit le nom du statefulset utilisé comme nom d&rsquo;hôte.</p><p>Le nom d&rsquo;hôte suit le même schéma dans tous les cas serviceName + un nombre commençant à 0 et il est incrémenté de un pour chaque réplique.</p><p>Et un service headless :</p><pre tabindex=0><code>---
apiVersion: v1
kind: Service
metadata:
  name: quarkus-statefulset
  labels:
    app: quarkus-statefulset
spec:
  ports:
  - port: 8080
    name: web
  clusterIP: None (1)
  selector:
    app: quarkus-statefulset
</code></pre><p>1- Rend le service headless.</p><pre tabindex=0><code>kubectl apply -f apps/kubefiles/quarkus-statefulset.yaml

kubectl get pods
</code></pre><pre tabindex=0><code>NAME                     READY   STATUS    RESTARTS   AGE
quarkus-statefulset-0   1/1     Running   0          12s
</code></pre><p>Remarquez que le nom du pod est le serviceName avec un 0, car il s&rsquo;agit de la première instance.</p><pre tabindex=0><code>kubectl get statefulsets
</code></pre><pre tabindex=0><code>NAME                   READY   AGE
quarkus-statefulset   1/1     109s
</code></pre><p>Maintenant, on scale l&rsquo;application avec 3 instances</p><pre tabindex=0><code>kubectl scale statefulset quarkus-statefulset --replicas=3

kubectl get pods
</code></pre><pre tabindex=0><code>NAME                     READY   STATUS    RESTARTS   AGE
quarkus-statefulset-0   1/1     Running   0          95s
quarkus-statefulset-1   1/1     Running   0          2s
quarkus-statefulset-2   1/1     Running   0          1s
</code></pre><p>Remarquez que le nom des Pods utilise la même nomenclature de serviceName + numéro incrémental.</p><p>De plus, si vous vérifiez l&rsquo;ordre des événements dans le cluster Kubernetes, vous remarquerez que le nom du Pod se terminant par -1 est créé en premier, puis celui se terminant par -2.</p><pre tabindex=0><code>kubectl get events --sort-by=.metadata.creationTimestamp
</code></pre><pre tabindex=0><code>4m4s        Normal   SuccessfulCreate          statefulset/quarkus-statefulset   create Pod quarkus-statefulset-1 in StatefulSet quarkus-statefulset successful
4m3s        Normal   Pulled                    pod/quarkus-statefulset-1         Container image &#34;quay.io/rhdevelopers/quarkus-demo:v1&#34; already present on machine
4m3s        Normal   Scheduled                 pod/quarkus-statefulset-2         Successfully assigned default/quarkus-statefulset-2 to kube
4m3s        Normal   Created                   pod/quarkus-statefulset-1         Created container quarkus-statefulset
4m3s        Normal   Started                   pod/quarkus-statefulset-1         Started container quarkus-statefulset
4m3s        Normal   SuccessfulCreate          statefulset/quarkus-statefulset   create Pod quarkus-statefulset-2 in StatefulSet quarkus-statefulset successful
4m2s        Normal   Pulled                    pod/quarkus-statefulset-2         Container image &#34;quay.io/rhdevelopers/quarkus-demo:v1&#34; already present on machine
4m2s        Normal   Created                   pod/quarkus-statefulset-2         Created container quarkus-statefulset
4m2s        Normal   Started                   pod/quarkus-statefulset-2         Started container quarkus-statefulset
</code></pre><p>Enfin, si nous réduisons à deux instances, celle qui est détruite n&rsquo;est pas choisie au hasard, mais celle qui a été lancée plus tard (quarkus.statefulset-2).</p><pre tabindex=0><code>kubectl scale statefulset quarkus-statefulset --replicas=2

kubectl get pods
</code></pre><pre tabindex=0><code>NAME                     READY   STATUS        RESTARTS   AGE
quarkus-statefulset-0   1/1     Running       0          9m22s
quarkus-statefulset-1   1/1     Running       0          7m49s
quarkus-statefulset-2   0/1     Terminating   0          7m48s
</code></pre><p>Supprimer les ressources</p><pre tabindex=0><code>kubectl delete -f apps/kubefiles/quarkus-statefulset.yaml
</code></pre><footer class=footline></footer></div></div><div id=navigation><a class="nav nav-prev" href=/kubernetes-tutorial/kubernetes/intermediare/daemonset/ title=Daemonset><i class="fa fa-chevron-left"></i></a>
<a class="nav nav-next" href=/kubernetes-tutorial/kubernetes/avance/ title=Avancé style=margin-right:0><i class="fa fa-chevron-right"></i></a></div></section><div style=left:-1000px;overflow:scroll;position:absolute;top:-1000px;border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px><div style=border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px></div></div><script src=/kubernetes-tutorial/js/clipboard.min.js?1719415791></script><script src=/kubernetes-tutorial/js/perfect-scrollbar.min.js?1719415791></script><script src=/kubernetes-tutorial/js/perfect-scrollbar.jquery.min.js?1719415791></script><script src=/kubernetes-tutorial/js/jquery.sticky.js?1719415791></script><script src=/kubernetes-tutorial/js/featherlight.min.js?1719415791></script><script src=/kubernetes-tutorial/js/highlight.pack.js?1719415791></script><script>hljs.initHighlightingOnLoad()</script><script src=/kubernetes-tutorial/js/modernizr.custom-3.6.0.js?1719415791></script><script src=/kubernetes-tutorial/js/learn.js?1719415791></script><script src=/kubernetes-tutorial/js/hugo-learn.js?1719415791></script><script src=/kubernetes-tutorial/mermaid/mermaid.js?1719415791></script><script>mermaid.initialize({startOnLoad:!0})</script></body></html>